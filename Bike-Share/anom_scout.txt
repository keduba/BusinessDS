pip install torch torchvision

import torch
import torchvision
from torchvision import datasets, transforms

# Define the transform for the images
transform = transforms.Compose([transforms.ToTensor()])

# Load the MVTec dataset
dataset = datasets.MVTec(root='./mvtec', name='bottle', transform=transform, train=True)


import matplotlib.pyplot as plt

# Plot some images
fig, axs = plt.subplots(2, 5, figsize=(20, 8))
for i in range(10):
    img, _ = dataset[i]
    axs[i // 5, i % 5].imshow(img.permute(1, 2, 0).numpy())
    axs[i // 5, i % 5].axis('off')
plt.show()


import torch.nn as nn

class AnomalyDetectionModel(nn.Module):
    def __init__(self):
        super(AnomalyDetectionModel, self).__init__()
        self.encoder = nn.Sequential(
            nn.Conv2d(3, 64, kernel_size=3),
            nn.ReLU(),
            nn.MaxPool2d(2, 2),
            nn.Conv2d(64, 128, kernel_size=3),
            nn.ReLU(),
            nn.MaxPool2d(2, 2)
        )
        self.decoder = nn.Sequential(
            nn.ConvTranspose2d(128, 64, kernel_size=2, stride=2),
            nn.ReLU(),
            nn.ConvTranspose2d(64, 3, kernel_size=2, stride=2),
            nn.Sigmoid()
        )

    def forward(self, x):
        x = self.encoder(x)
        x = self.decoder(x)
        return x

model = AnomalyDetectionModel()


import torch.optim as optim

criterion = nn.MSELoss()
optimizer = optim.Adam(model.parameters(), lr=0.001)

for epoch in range(10):
    for img, _ in dataset:
        img = img.unsqueeze(0)
        optimizer.zero_grad()
        output = model(img)
        loss = criterion(output, img)
        loss.backward()
        optimizer.step()
    print(f'Epoch {epoch+1}, Loss: {loss.item()}')


threshold = 0.05

with torch.no_grad():
    for img, _ in dataset:
        img = img.unsqueeze(0)
        output = model(img)
        loss = criterion(output, img)
        if loss.item() > threshold:
            print('Anomaly detected!')

test_dataset = datasets.MVTec(root='./mvtec', name='bottle', transform=transform, train=False)


model.eval()
test_preds = []
test_labels = []

with torch.no_grad():
    for img, label in test_dataset:
        img = img.unsqueeze(0)
        output = model(img)
        loss = criterion(output, img)
        if loss.item() > threshold:
            test_preds.append(1)  # Anomaly detected
        else:
            test_preds.append(0)  # No anomaly detected
        test_labels.append(label.item())


from sklearn.metrics import precision_score, recall_score, f1_score

precision = precision_score(test_labels, test_preds)
recall = recall_score(test_labels, test_preds)
f1 = f1_score(test_labels, test_preds)

print(f'Precision: {precision:.4f}')
print(f'Recall: {recall:.4f}')
print(f'F1 Score: {f1:.4f}')
